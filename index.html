<!DOCTYPE html>  <html> <head>   <title>graft.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               graft.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Graft 0.1
(c) 2011 Evan Hensleigh</p>

<p>A relational data extension for Backbone.js
(in case you want one)</p>

<p>Freely distributed under MIT license.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Graft can only run if Backbone is present</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">if</span> <span class="o">not</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Backbone</span><span class="o">?</span>
	<span class="k">throw</span> <span class="s2">&quot;Backbone is not running!&quot;</span>
	<span class="k">return</span> <span class="kc">false</span>

<span class="nv">Backbone = </span><span class="nb">window</span><span class="p">.</span><span class="nx">Backbone</span>

<span class="nv">Graft = Backbone.Graft = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Create a home for the original (reference) implementations
in case we opt to overwrite them later.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">R = Graft.Reference = </span><span class="p">{}</span>
<span class="nv">R.Model = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span>
<span class="nv">R.Collection = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Graft.Joined is a new model that handles Join results.
A Graft.Joined has some special, modified methods.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Graft.Joined = </span><span class="nx">R</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span>
	<span class="nv">join		:	</span><span class="kc">false</span>
	</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Graft.Joined stores data across joins as JSON data--this means
your result set will have data nested behind the joins</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">initialize	:	</span><span class="nf">( startModel, options ) -&gt;</span>
		<span class="k">if</span> <span class="nx">startModel</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">startModel</span> <span class="k">instanceof</span> <span class="nx">R</span><span class="p">.</span><span class="nx">Model</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">false</span>				<span class="c1"># must be a model</span>
		<span class="k">if</span> <span class="o">not</span> <span class="nx">options</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">as</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">false</span>									<span class="c1"># as is required</span>
	
		<span class="nv">as = </span><span class="nx">options</span><span class="p">.</span><span class="nx">as</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">join</span> <span class="o">?=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">join</span>
	
		<span class="nv">data = </span><span class="p">{}</span>
		<span class="nx">data</span><span class="p">[</span><span class="nx">as</span><span class="p">]</span> <span class="o">=</span> <span class="nx">startModel</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>												<span class="c1"># pour the data in</span>
		<span class="k">this</span><span class="p">.</span><span class="nx">set</span> <span class="nx">data</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Slightly tweaked version of get here.
This version of get lets us pull nested data.
Really, this is how the get function should work by default,
since nested data is handy in other instances as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">get			:	</span><span class="nf">( attrName ) -&gt;</span>
		<span class="nv">attrs = </span><span class="nx">attrName</span><span class="p">.</span><span class="nx">split</span> <span class="s1">&#39;.&#39;</span>													<span class="c1"># break on dots!</span>
		<span class="nv">result = </span><span class="nx">R</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>						<span class="c1"># call the straight object</span>
	
		<span class="nv">result = </span><span class="nx">result</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="k">for</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">attrs</span>										<span class="c1"># now we get down to the heart of the matter</span>
	
		<span class="k">return</span> <span class="nx">result</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This will merge another Joined's data into this one, for handling
multiple joins.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">mergeIn		:	</span><span class="nf">( joinModel, name ) -&gt;</span>
		<span class="k">if</span> <span class="nx">joinModel</span> <span class="k">instanceof</span> <span class="nx">Graft</span><span class="p">.</span><span class="nx">Joined</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">joinModel</span><span class="p">,</span> <span class="p">(</span> <span class="nx">member</span> <span class="p">)</span> <span class="o">=&gt;</span>
				<span class="k">if</span> <span class="o">not</span> <span class="nx">member</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
					<span class="k">throw</span> <span class="s2">&quot;Can&#39;t join.&quot;</span>
					<span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Graft.Collection is a modified version of the standard collection
that allows you to run joins. If you plan to use Graft, all of your
collections should be Graft collections, not Backbone collections.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Graft.Collection = </span><span class="nx">R</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span>
	
	<span class="nv">_findByAttribute	:	</span><span class="nf">( attr, value ) -&gt;</span>
		<span class="nv">ret = </span><span class="k">this</span><span class="p">.</span><span class="nx">select</span> <span class="nf">( member ) -&gt;</span> <span class="nx">member</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="nx">attr</span> <span class="p">)</span> <span class="o">is</span> <span class="nx">value</span>
		<span class="k">return</span> <span class="nx">ret</span>
		
	<span class="nv">filterByAttribute	:	</span><span class="nf">( attr, value ) -&gt;</span>
		<span class="nv">ret = </span><span class="k">new</span> <span class="nx">Graft</span><span class="p">.</span><span class="nx">Collection</span>
		
		<span class="nx">ret</span><span class="p">.</span><span class="nx">add</span> <span class="nx">element</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">_findByAttribute</span><span class="p">(</span><span class="nx">attr</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
		
		<span class="k">return</span> <span class="nx">ret</span>
	</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This is an INNER JOIN
joinOrders take the form of: <br />
{ linkCollection: Collection, as: name, fromName: name, fromKey: keyname, linkKey: keyname } <br />
- <em>linkCollection</em> is what you're bringing in <br />
- <em>as</em> is its alias -- note that as is <strong>required</strong> <br />
- <em>fromName</em> is the alias of the set in the join you're connecting to - it defaults to the starting set <br />
- <em>fromKey</em> is the join key for the set in the join <br />
- <em>linkKey</em> is the join key for the set you're bringing in</p>

<p>Be sure that all of your aliases across the join are unique, or the join
will fail.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nv">join		: </span><span class="nf">( as, joinOrders... ) -&gt;</span>
		
		<span class="nv">aliases = </span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">joinOrders</span><span class="p">,</span> <span class="s1">&#39;as&#39;</span><span class="p">).</span><span class="nx">push</span> <span class="nx">as</span>								<span class="c1"># make sure our aliases are all unique</span>
		<span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">unique</span><span class="p">(</span> <span class="nx">aliases</span> <span class="p">).</span><span class="nx">length</span> <span class="o">is</span> <span class="nx">aliases</span><span class="p">.</span><span class="nx">length</span> 
			<span class="k">throw</span> <span class="s2">&quot;All aliases in the join must be unique.&quot;</span>						<span class="c1"># no good!</span>
			<span class="k">return</span> <span class="kc">false</span>
		
		<span class="nv">joined = </span><span class="k">new</span> <span class="nx">Graft</span><span class="p">.</span><span class="nx">Collection</span>											<span class="c1"># the result collection</span>
		
		<span class="k">this</span><span class="p">.</span><span class="nx">each</span> <span class="nf">( member ) -&gt;</span>													<span class="c1"># Start by dumping the current collection in.</span>
			<span class="nx">joined</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Graft</span><span class="p">.</span><span class="nx">Joined</span> <span class="nx">member</span><span class="p">,</span> <span class="nv">as: </span><span class="nx">as</span><span class="p">,</span> <span class="nv">join: </span><span class="kc">true</span>				<span class="c1"># We&#39;ll do this iteratively to shift everything into Graft.Joined models.</span>
		
		<span class="k">for</span> <span class="nx">order</span> <span class="k">in</span> <span class="nx">joinOrders</span>													<span class="c1"># iterate over the join orders</span>
			<span class="nx">do</span> <span class="p">(</span> <span class="nx">order</span> <span class="p">)</span> <span class="o">=&gt;</span>														<span class="c1"># make sure we have a well-formed join order</span>
				<span class="k">if</span> <span class="o">not</span> <span class="nx">order</span><span class="p">.</span><span class="nx">linkCollection</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">order</span><span class="p">.</span><span class="nx">linkCollection</span> <span class="k">instanceof</span> <span class="nx">Graft</span><span class="p">.</span><span class="nx">Collection</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">false</span>
				<span class="k">if</span> <span class="o">not</span> <span class="nx">order</span><span class="p">.</span><span class="nx">fromKey</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">order</span><span class="p">.</span><span class="nx">linkKey</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">order</span><span class="p">.</span><span class="nx">as</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">false</span>
			
				<span class="nv">_joined_ = </span><span class="k">new</span> <span class="nx">Graft</span><span class="p">.</span><span class="nx">Collection</span>									<span class="c1"># we&#39;re going to be writing over the join soon</span>
				
				<span class="nv">name = </span><span class="nx">order</span><span class="p">.</span><span class="nx">fromName</span> <span class="o">?</span> <span class="nx">as</span>										<span class="c1"># default the fromName</span>
			
				<span class="nx">joined</span><span class="p">.</span><span class="nx">each</span> <span class="nf">( member ) -&gt;</span>										<span class="c1"># great! let&#39;s get joining</span>
					
					<span class="nv">matches = </span><span class="nx">order</span><span class="p">.</span><span class="nx">linkCollection</span><span class="p">.</span><span class="nx">_findByAttribute</span> <span class="nx">order</span><span class="p">.</span><span class="nx">linkKey</span><span class="p">,</span> <span class="nx">member</span><span class="p">.</span><span class="nx">get</span> <span class="nx">name</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="nx">order</span><span class="p">.</span><span class="nx">fromKey</span>		<span class="c1"># First we pull all the elements that match this element</span>
					<span class="nv">memberItems = </span><span class="nx">member</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>																			<span class="c1"># out of the collection we&#39;re bringing in.</span>
					
					<span class="k">for</span> <span class="nx">match</span> <span class="k">in</span> <span class="nx">matches</span>										<span class="c1"># Now iterate over the matches and create unified result join models.</span>
						<span class="nx">do</span> <span class="nf">( match ) -&gt;</span>											<span class="c1"># We append it to the preexisting &quot;joined&quot; collection.</span>
							<span class="nv">joinMember = </span><span class="k">new</span> <span class="nx">Graft</span><span class="p">.</span><span class="nx">Joined</span>
							
							<span class="nv">joinData = </span><span class="nx">memberItems</span>								<span class="c1"># start with the join set</span>
							<span class="nx">joinData</span><span class="p">[</span><span class="nx">order</span><span class="p">.</span><span class="nx">as</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>					<span class="c1"># add in the new join data</span>
							<span class="nx">joinMember</span><span class="p">.</span><span class="nx">set</span> <span class="nx">joinData</span>
							
							<span class="nx">_joined_</span><span class="p">.</span><span class="nx">add</span> <span class="nx">joinMember</span>
							
				<span class="nv">joined = </span><span class="nx">_joined_</span>												<span class="c1"># overwrite the old joined</span>
				
		<span class="k">return</span> <span class="nx">joined</span>															<span class="c1"># and finally, return the join</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>This sends Graft into "overrun" mode, which makes Graft overwrite the standard
model and controller. This lets you write more convenient code, but it could screw
other things up, if they depend on the standard implementations of Backbone's
model and controller. Use at your own risk.</p>

<p>Note that if you use overrun mode, you can still access the reference implementations
at Backbone.Graft.Reference.Model and Backbone.Graft.Reference.Collection</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Graft.Overrun = </span><span class="o">-&gt;</span>
	<span class="nv">Backbone.Model = </span><span class="nx">Graft</span><span class="p">.</span><span class="nx">Joined</span>
	<span class="nv">Backbone.Collection = </span><span class="nx">Graft</span><span class="p">.</span><span class="nx">Collection</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 